module ks(drinkout,changemoney,half,reset,clk,seg,out);

parameter s0=3'b000,s1=3'b001,s2=3'b010,s3=3'b011,s4=3'b100;//状态机

output drinkout,changemoney; //饮料;找零

input one,half,reset,clk; //1，0.5

output seg;//位选
output out;//段选

reg[7:0]seg;
reg[7:0]out;
reg[4:0]sum;
reg[4:0]change;
reg[4:0]temp;

reg[4:0]state1;//状态
reg[3:0]state2;//数码管

reg drinkout,changemoney;

reg puth,puti;

//状态机
always @(negedge reset, posedge one, posedge half, posedge clk)
begin
	if(!reset)
			begin
			drinkout=0;
			changemoney=0;
			state1=0;
		   puthh=0;puthi=0;
			sum=0; change=0;
			end 
    else if(half) puth=1;                                         
    else if(one)  puti=1;
    else
        begin 
              case(state1)
				  s0:begin drinkout=0;changemoney=0;
					   sum=0; change=0;
					   if(puth==1)begin //投入0.5元，进入状态s1
							state1=s1;puth=0; end
					   else if(puti==1)begin // 投入1元，进入状态s2
							state1=s2;puthi=0; end
                     else state1 = s0; 
					  end
				  s1: begin drinkout=0;changemoney=0; //已投0.5元
					  sum=5'd5; change=0;
					   if(puth==1)begin 
							state1=s2;puth=0; end
						else if(puthi==1)begin
	                  state1=s3;puthi=0; end
                     else state1 = s1; 
					  end
				  s2: begin drinkout=0;changemoney=0; //已投1元
					  sum=5'd10; change=0;
					   if(puth==1)begin  
							state1=s3;puth=0; end  
					   else if(puthi==1)begin 
							state1=s4;puthi=0; end  
                    else state1 = s2; 
					   end
//已经投入1.5元，售出饮料，找零为0元
				  s3: begin drinkout=0;changemoney=1;  					  					   	 
				     sum=5'd15; change=0;
					  puth=0; puthi=0;
                    state1 = s3;
					  end  
 //已经投入2元，则售出饮料，找零0.5元
              s4: begin drinkout=1;changemoney=1;  
					  sum=5'd20; change=5'd5;
					  puth=0; puthi=0;
                   state1 = s4;
					  end
             endcase
        end
end          

//用于控制哪个数码管亮，在这几个状态之间一直循环，形成同时亮的视觉现象

always@(posedge clk)
begin
	case(state2)  
	0:	begin //显示找零值
			begin
			seg=8'b0000_0001; out[7]=0; 
			if(change==0) temp=0;
			else temp=5'd5;
			end
			state2=1;
		end
	1:	begin //显示投币总额的个位数
			seg=8'b0001_0000; out[7]=0;
			if(sum==0 || sum==5'd10 || sum==5'd20) temp=0;
			else temp=5'd5;
			state2=2;
		end
	2:	begin	//显示投币总额的十位数
			seg=8'b0010_0000;out[7]=1;
			if(sum==0 || sum==5'd5) temp=0;
			else if(sum==5'd10 || sum==5'd15) temp =5'd1;
			else temp = 5'd2;
			state2=3;
		end
	3: begin
			seg=8'b0000_0010; out[7]=1; 
			temp=0;
			state2=0;
			end
	default:state2=0;
	endcase
end
always@(temp) begin  //接数码管
	case(temp)  //共就四种显示
		5'd0:out[6:0]=7'b111_1110;
		5'd1:out[6:0]=7'b011_0000;
		5'd2:out[6:0]=7'b110_1101;
		5'd5:out[6:0]=7'b101_1011;
	endcase
end

endmodule